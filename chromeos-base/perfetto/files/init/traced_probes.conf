# Copyright 2020 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Starts perfetto system tracing service and probes"
author        "chromium-os-dev@chromium.org"

start on started traced
stop on stopping traced
expect fork
respawn
respawn limit 10 10
oom score -100
# Use 10 times regular as usage, which is ~240 MiB for memory usage limit.
# Note that internally perfetto has it's own watchdog and will self-kill if its
# memory budget exceeds SUM(tracing buffers) + 32MB slack.
limit as 250000000 unlimited

env PERFETTO_SOCK_DIR=/run/perfetto
env PERFETTO_PRODUCER_SOCK_NAME=/run/perfetto/traced-producer.sock

pre-start script
  # Make per_cpu trace file writable for group debugfs-access.
  chgrp debugfs-access /sys/kernel/debug/tracing/per_cpu/cpu*/trace
  chmod g+w /sys/kernel/debug/tracing/per_cpu/cpu*/trace
  # Allow group debugfs-access to eanble tracing events through writing to the
  # "enable" files.
  find /sys/kernel/debug/tracing/events -name enable \
    -exec chgrp debugfs-access {} + -exec chmod g+w {} +
end script

# minijail0 args.
# -u traced-probes -g traced-probes: run as user: traced-probes,
#   group: traced-probes.
# -G: Inherit supplementary groups from new uid.
# -c 0: Grant no caps.
# -i: fork immediately and don't block the startup.
# -l: enter a new IPC namespace.
# -e: enter a new network namespace.
# --uts: enter a new UTS namespace.
# traced_probes runs without -p because it needs to see the PID of the traced
# processes.
# -n: set no new_privs.
# -b /sys: bind mount sysfs.
# -b /sys/kernel/debug/tracing,/sys/kernel/tracing,1: bind mount tracefs to
#   /sys/kernel/tracing so we don't need to enable debugfs in the sandbox.
exec /sbin/minijail0 -u traced-probes -g traced-probes \
  -G -c 0 -i -l -e --uts -n \
  --profile=minimalistic-mountns -t \
  -k 'tmpfs,/run,tmpfs,MS_NOSUID|MS_NODEV|MS_NOEXEC' \
  -b "${PERFETTO_SOCK_DIR}",,1 \
  -b /sys \
  -b /sys/kernel/debug/tracing,/sys/kernel/tracing,1 \
  -S /usr/share/policy/traced_probes.policy \
  -- /usr/bin/traced_probes
