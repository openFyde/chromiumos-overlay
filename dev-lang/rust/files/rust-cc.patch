From cc7390e43c72774f174018eff5ab17ad8523e214 Mon Sep 17 00:00:00 2001
From: Michael Benfield <mbenfield@google.com>
Date: Mon, 14 Nov 2022 05:48:29 +0000
Subject: [PATCH] for patch

---
 compiler/rustc_codegen_ssa/src/back/link.rs | 25 ++++++++++++---------
 1 file changed, 14 insertions(+), 11 deletions(-)

diff --git a/compiler/rustc_codegen_ssa/src/back/link.rs b/compiler/rustc_codegen_ssa/src/back/link.rs
index 6cce9542746..8bfe36164ad 100644
--- a/compiler/rustc_codegen_ssa/src/back/link.rs
+++ b/compiler/rustc_codegen_ssa/src/back/link.rs
@@ -1186,7 +1186,7 @@ fn infer_from(
             (Some(linker), Some(flavor)) => Some((linker, flavor)),
             // only the linker flavor is known; use the default linker for the selected flavor
             (None, Some(flavor)) => Some((
-                PathBuf::from(match flavor {
+                match flavor {
                     LinkerFlavor::Gcc => {
                         if cfg!(any(target_os = "solaris", target_os = "illumos")) {
                             // On historical Solaris systems, "cc" may have
@@ -1195,24 +1195,27 @@ fn infer_from(
                             // and many modern illumos distributions today
                             // ship GCC as "gcc" without also making it
                             // available as "cc".
-                            "gcc"
+                            "gcc".into()
                         } else {
-                            "cc"
+                            match env::var_os("CC") {
+                                Some(path) => path.into(),
+                                None => "cc".into(),
+                            }
                         }
                     }
-                    LinkerFlavor::Ld => "ld",
-                    LinkerFlavor::Lld(_) => "lld",
-                    LinkerFlavor::Msvc => "link.exe",
+                    LinkerFlavor::Ld => "ld".into(),
+                    LinkerFlavor::Lld(_) => "lld".into(),
+                    LinkerFlavor::Msvc => "link.exe".into(),
                     LinkerFlavor::EmCc => {
                         if cfg!(windows) {
-                            "emcc.bat"
+                            "emcc.bat".into()
                         } else {
-                            "emcc"
+                            "emcc".into()
                         }
                     }
-                    LinkerFlavor::Bpf => "bpf-linker",
-                    LinkerFlavor::Ptx => "rust-ptx-linker",
-                }),
+                    LinkerFlavor::Bpf => "bpf-linker".into(),
+                    LinkerFlavor::Ptx => "rust-ptx-linker".into(),
+                },
                 flavor,
             )),
             (Some(linker), None) => {
-- 
2.38.1.431.g37b22c650d-goog

