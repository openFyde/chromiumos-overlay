From c2b8a0784212a0a17066536305960fd6f011af4b Mon Sep 17 00:00:00 2001
From: chuanli1 <chuan1.liu@intel.com>
Date: Wed, 13 Jul 2022 12:16:09 +0800
Subject: [PATCH] [Decode] set invalid reference surface index

fix avc invalid surface index regression
---
 .../common/codec/ddi/media_ddi_decode_avc.cpp     | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/media_driver/linux/common/codec/ddi/media_ddi_decode_avc.cpp b/media_driver/linux/common/codec/ddi/media_ddi_decode_avc.cpp
index f3bb1c51e..0ed7d877e 100644
--- a/media_driver/linux/common/codec/ddi/media_ddi_decode_avc.cpp
+++ b/media_driver/linux/common/codec/ddi/media_ddi_decode_avc.cpp
@@ -269,9 +269,7 @@ VAStatus DdiDecodeAVC::ParsePicParams(
 
     //Accoding to RecList, if the surface id is invalid, set PicFlags equal to PICTURE_INVALID
     for (i = 0; i < CODEC_MAX_NUM_REF_FRAME; i++)
-    {
-        if (avcPicParams->RefFrameList[i].FrameIdx >= CODEC_AVC_NUM_UNCOMPRESSED_SURFACE)
-            return VA_STATUS_ERROR_INVALID_PARAMETER;        
+    {     
         //Check the surface id of reference list
         if (VA_INVALID_ID == m_ddiDecodeCtx->RecListSurfaceID[avcPicParams->RefFrameList[i].FrameIdx])
         {
@@ -928,8 +926,15 @@ void DdiDecodeAVC::SetupCodecPicture(
     if(vaPic.picture_id != DDI_CODEC_INVALID_FRAME_INDEX)
     {
         DDI_MEDIA_SURFACE *surface = DdiMedia_GetSurfaceFromVASurfaceID(mediaCtx, vaPic.picture_id);
-        vaPic.frame_idx    = GetRenderTargetID(rtTbl, surface);
-        codecHalPic->FrameIdx = (uint8_t)vaPic.frame_idx;
+        vaPic.frame_idx    = GetRenderTargetID(rtTbl, surface);    
+        if(vaPic.frame_idx == DDI_CODEC_INVALID_FRAME_INDEX)
+        {
+            codecHalPic->FrameIdx = CODEC_AVC_NUM_UNCOMPRESSED_SURFACE - 1;
+        }
+        else
+        {
+            codecHalPic->FrameIdx = (uint8_t)vaPic.frame_idx;
+        }
     }
     else
     {
-- 
2.38.0.413.g74048e4d9e-goog

