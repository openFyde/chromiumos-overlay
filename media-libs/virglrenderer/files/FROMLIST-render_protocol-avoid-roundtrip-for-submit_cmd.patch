From 8fffc153c9099e03b9aa904315bfe3a1099f20b3 Mon Sep 17 00:00:00 2001
From: Yiwei Zhang <zzyiwei@chromium.org>
Date: Sun, 5 Mar 2023 14:58:31 -0800
Subject: [PATCH 1/5] render_protocol: avoid roundtrip for submit_cmd

vtest no longer requires it after deprecating globalFencing.

Signed-off-by: Yiwei Zhang <zzyiwei@chromium.org>
---
 server/render_context.c   |  8 +-------
 server/render_protocol.h  |  4 ----
 src/proxy/proxy_context.c | 11 +----------
 3 files changed, 2 insertions(+), 21 deletions(-)

diff --git a/server/render_context.c b/server/render_context.c
index 3b962797..3bf7c228 100644
--- a/server/render_context.c
+++ b/server/render_context.c
@@ -66,13 +66,7 @@ render_context_dispatch_submit_cmd(struct render_context *ctx,
    if (cmd != req->cmd)
       free(cmd);
 
-   const struct render_context_op_submit_cmd_reply reply = {
-      .ok = ok,
-   };
-   if (!render_socket_send_reply(&ctx->socket, &reply, sizeof(reply)))
-      return false;
-
-   return true;
+   return ok;
 }
 
 static bool
diff --git a/server/render_protocol.h b/server/render_protocol.h
index 88c2cb5e..7e38ac0c 100644
--- a/server/render_protocol.h
+++ b/server/render_protocol.h
@@ -193,10 +193,6 @@ struct render_context_op_submit_cmd_request {
     */
 };
 
-struct render_context_op_submit_cmd_reply {
-   bool ok;
-};
-
 /* Submit a fence to the context.
  *
  * This submits a fence to the specified ring.  When the fence signals, the
diff --git a/src/proxy/proxy_context.c b/src/proxy/proxy_context.c
index 1d18159a..dba2eab5 100644
--- a/src/proxy/proxy_context.c
+++ b/src/proxy/proxy_context.c
@@ -294,16 +294,7 @@ proxy_context_submit_cmd(struct virgl_context *base, const void *buffer, size_t
       }
    }
 
-   /* XXX this is forced a roundtrip to avoid surprises; vtest requires this
-    * at least
-    */
-   struct render_context_op_submit_cmd_reply reply;
-   if (!proxy_socket_receive_reply(&ctx->socket, &reply, sizeof(reply))) {
-      proxy_log("failed to get submit result");
-      return -1;
-   }
-
-   return reply.ok ? 0 : -1;
+   return 0;
 }
 
 static bool
-- 
2.37.3

