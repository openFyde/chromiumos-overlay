# Copyright 2016 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description     "CUPS daemon"
author          "chromium-os-dev@chromium.org"

oom score -100

env user=cups
env seccomp_flags="-S /usr/share/policy/cupsd-seccomp.policy"

# Start only on request.
start on socket PROTO=unix SOCKET_PATH=/run/cups/cups.sock
stop on stopping ui

pre-start script
	if ! status ui | grep -q "ui start/running"; then
		logger -t "${UPSTART_JOB}" "ui not running"
		stop
		exit 0
	fi
	# Create temporary directories used by CUPS.
	systemd-tmpfiles --create --remove /usr/lib/tmpfiles.d/cupsd.conf
end script

exec minijail0 -IlnNprv -t --uts --mount-dev \
	-u ${user} -g nobody -G \
	${seccomp_flags} \
	-P /mnt/empty \
	-b / \
	-b /proc \
	-b /sys \
	-b /dev/log \
	-b /dev/bus/usb \
	-k 'run,/run,tmpfs,MS_NOSUID|MS_NODEV|MS_NOEXEC' \
	-b /run/avahi-daemon \
	-b /run/dbus \
	-b /run/ippusb \
	-b /run/cups,,1 \
	-b /run/shill \
	-k 'var,/var,tmpfs,MS_NOSUID|MS_NODEV|MS_NOEXEC' \
	-b /var/spool/cups,,1 \
	-b /var/cache/cups,,1 \
	-- /usr/sbin/cupsd -f -l
